@{
  Layout = "_WelcomeLayout";
  var cardapioUrl = Url.Action("Cardapio", "Home");
}

<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrinho - Totem FastFood</title>
  <link rel="stylesheet" href="@Url.Content("~/css/carrinho.css")">
</head>

<body>

  <header>


  </header>

  <div class="headCar">
    <h1> Carrinho de (usuario)</h1>
    <button class="back-btn" onclick="redirecionarCardapio()">‚Üê Voltar</button>
  </div>
  <!-- Botao para abrir o modal de cupom -->
  <button class="open-modal-btn botao-cupom" onclick="openModal()">Adicionar Cupom</button>
  <!-- Modal de cupom -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <button class="close-btn" onclick="closeModal()">&times;</button>
      <h2>ADICIONE O CUPOM</h2>
      <input type="text" id="nome" value="" readonly maxlength="10" />



      <div class="keyboard" id="keyboard"></div>
    </div>
  </div>

  </div>
  <main class="cart-container">

    <div class="cart-items">
      <div class="cart-item">
        <img src="~/img/back1.jpg" alt="Whopper">
        <div class="item-info">
          <h2>Big Css</h2>
          <p>*sem alface*</p>
        </div>
        <div class="item-price">
          <p>R$ 27,90</p>
          <div class="quantity">
            <button>-</button>
            <span>1</span>
            <button>+</button>
          </div>
        </div>
      </div>
      <p class="edit-item"> <a href="#">Editar Item</a></p>
    </div>


    <section class="suggestions">
      <h2>Turbine seu pedido!</h2>
      <div class="suggestions-container">
        <div class="suggestion-item">
          <img src="~/img/bebidas.png" alt="Free Refill">
          <p>Free Refill</p>
          <p>R$ 5,00</p>
          <button style="
                margin-top: 25px;
            ">+</button>
        </div>
        <div class="suggestion-item">
          <img src="~/img/d4u1GTvl_kmUrrsUwaj0OV0huie-m7AFB15UzmGDqoU.jpg" alt="Batata Frita Grande">
          <p>Batata Frita Grande</p>
          <p>R$ 8,00</p>
          <button>+</button>
        </div>
        <div class="suggestion-item">
          <img src="~/img/sobremesas1.jpg" alt="Casquinha Baunilha">
          <p>Casquinha Baunilha</p>
          <p>R$ 4,00</p>
          <button>+</button>
        </div>
      </div>
    </section>
  </main>


  <footer class="cart-summary">
    <div class="total">
      <p>Total a pagar:</p>
      <p class="total-price">R$ 27,90</p>
    </div>
    <button class="checkout-btn" onclick="redirecionarEscolha()">Finalizar Pedido</button>
    <p class="cancel-order">Cancelar Pedido</p>
  </footer>

</body>

</html>

<script>
  const cardapioUrl = '@cardapioUrl';

  function redirecionarCardapio() {
    window.location.href = cardapioUrl;
  }

  function redirecionarEscolha() {
    window.location.href = "escolha";
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
    const container = document.querySelector(".cart-items");
    const totalPreco = document.querySelector(".total-price");

    container.innerHTML = ""; // Limpa conte√∫do fixo
    let totalGeral = 0;
    itens.forEach((item, index) => {
      const ingredientes = Object.entries(item.ingredientes)
        .map(([nome, qtd]) => `${qtd}x ${nome}`)
        .join(", ");

      totalGeral += item.total;

      container.innerHTML += `
    <div class="cart-item">
        <img src="${item.imagem}" alt="${item.nome}">
        <div class="item-info">
            <h2>${item.nome}</h2>
            <p>${ingredientes ? ingredientes : "Sem ingredientes extras"}</p>
        </div>
        <div class="item-price">
            <p>R$ ${item.total.toFixed(2).replace(".", ",")}</p>
            <div class="quantity">
                <button onclick="alterarQtd(${index}, -1)">-</button>
                <span>${item.quantidade}</span>
                <button onclick="alterarQtd(${index}, 1)">+</button>
                <p class="edit-item"><a href="#">Editar Item</a></p>
            </div>
        </div>
    </div>
    
`;

    });

    totalPreco.textContent = `R$ ${totalGeral.toFixed(2).replace(".", ",")}`;
  });

  function alterarQtd(index, delta) {
    let itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
    if (!itens[index]) return;

    itens[index].quantidade += delta;
    if (itens[index].quantidade <= 0) {
      itens.splice(index, 1); // Remove item se quantidade for zero
    } else {
      itens[index].total = itens[index].quantidade * itens[index].precoUnitario;
    }

    sessionStorage.setItem("itensCarrinho", JSON.stringify(itens));

    // Atualiza total
    let totalItens = 0, totalPedido = 0;
    itens.forEach(i => {
      totalItens += i.quantidade;
      totalPedido += i.total;
    });

    sessionStorage.setItem("totalItens", totalItens);
    sessionStorage.setItem("totalPedido", totalPedido.toFixed(2));

    location.reload(); // Recarrega a tela para atualizar os dados
  }
</script>

<script>
  function openModal() {
    document.getElementById("modalOverlay").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("modalOverlay").style.display = "none";
  }

  window.onload = () => {
    const keyboard = document.getElementById('keyboard');
    const input = document.getElementById('nome');

    const keys = [
      ..."ABCDEFGHIJ",
      ..."KLMNOPQRST",
      ..."UVWXYZ",
      "‚Üê", "Resetar", "Espa√ßo", "Enter"
    ];

    keys.forEach(key => {
      const button = document.createElement('button');
      button.textContent = key;
      button.classList.add('key');

      if (["Resetar", "Espa√ßo", "Enter"].includes(key)) {
        button.classList.add('key-spc');
      } 
      if (["‚Üê"].includes(key)) {
        button.classList.add('key-wide');
      }
      if (key === "Enter") button.classList.add("key-enter");
      if (key === "Resetar") button.classList.add("key-reset");

      button.addEventListener('click', () => {
        if (key === "‚Üê") {
          input.value = input.value.slice(0, -1);
        } else if (key === "Resetar") {
          input.value = "";
        } else if (key === "Espa√ßo") {
          if (input.value.length < 10) input.value += " ";
        } else if (key === "Enter") {
          submeterCupom(input.value);
        } else {
          if (input.value.length < 10) input.value += key;
        }
      });

      keyboard.appendChild(button);
    });

    // Protege caso o bot√£o "continuar" exista
    const continuar = document.getElementById('continuar');
    if (continuar) {
      continuar.addEventListener('click', () => {
        submeterCupom(input.value);
      });
    }
  };

  function submeterCupom(valorCupom) {
    if (!valorCupom.trim()) {
      alert("Por favor, insira um cupom v√°lido.");
      return;
    }
    if (sessionStorage.getItem("cupomAplicado") === "true") {
      alert("Cupom j√° aplicado a este pedido.");
      return;
    }
    fetch(`/Home/VerificarCupom?codigo=${encodeURIComponent(valorCupom)}`)
      .then(response => response.json())
      .then(data => {
        if (data.valido) {
          alert(`Cupom "${valorCupom}" aplicado com sucesso! üéâ`);

          const totalPreco = document.querySelector(".total-price");
          const valorAtual = parseFloat(totalPreco.textContent.replace("R$", "").replace(",", "."));
          const novoTotal = valorAtual * (1 - data.desconto);

          totalPreco.textContent = `R$ ${novoTotal.toFixed(2).replace(".", ",")}`;
          sessionStorage.setItem("cupomAplicado", "true");
        } else {
          alert(data.mensagem);
        }

        closeModal();
        document.getElementById("nome").value = "";
      })
      .catch(err => {
        alert("Erro ao verificar cupom.");
        console.error(err);
      });
  }
</script>
