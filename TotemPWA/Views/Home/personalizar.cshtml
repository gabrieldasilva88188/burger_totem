@{
    Layout = "_WelcomeLayout";
    var cardapioUrl = Url.Action("Cardapio", "Home");
    var nome = ViewBag.Nome ?? "Lanche";
    var preco = ViewBag.Preco ?? "0,00";
    var imagem = ViewBag.Imagem ?? "~/img/default.png";
}

<link rel="stylesheet" href="@Url.Content("~/css/personalizar.css")">

<div class="modal-content">

<img id="produto-imagem" src="@imagem" alt="@nome" />

    <h2 id="produto-nome">@(ViewBag.Editando == true ? "Editar " : "Personalizar ")@nome</h2>
    <p id="produto-preco">Pre√ßo: R$ @preco</p>

    <div class="info-ingredientes">
        <p><strong>üí° Dica:</strong> Os ingredientes j√° v√™m inclusos no lanche. Adicione mais se desejar!</p>
    </div>

    <h4 id="adicionar-ingredientes">Escolha os Ingredientes</h4>

    <div id="ingredientes-container">
        @if (ViewBag.Ingredientes != null)
        {
            foreach (var ingrediente in ViewBag.Ingredientes)
            {
                string nomeIngrediente = ingrediente.Name;
                int idIngrediente = ingrediente.Id;
                double precoIngrediente = (double)ingrediente.Price;
                int limite = ingrediente.Limit;
                int quantidade = ingrediente.Quantity;
                <div class="ingrediente-item">
                    <span class="ingrediente-nome">@nomeIngrediente (R$ @precoIngrediente.ToString("0.00"))</span>
                    <div class="ingrediente-controles">
                        <button class="diminuir" onclick="alterarIngrediente(@idIngrediente, -1)">-</button>
                        <span id="quantidade-@idIngrediente" class="quantidade">@quantidade</span>
                        <button class="aumentar" onclick="alterarIngrediente(@idIngrediente, 1)">+</button>
                    </div>
                    <img src="@Url.Content("~/img/ingredientes/" + @nomeIngrediente.ToLower() + ".png")" alt="@nomeIngrediente" class="ingrediente-img">
                </div>
            }
        }
    </div>

    <div class="botoes-personalizar">
        <button class="back-btn" onclick="redirecionarCardapio()">‚Üê Voltar</button>
        <button id="confirmar-personalizacao" onclick="adicionarAoCarrinho()">@(ViewBag.Editando == true ? "Atualizar Carrinho" : "Adicionar ao Carrinho")</button>
    
    </div>


</div>

<script>
    const cardapioUrl = '@cardapioUrl';
    let precoBaseOriginal = 0;

    function redirecionarCardapio() {
        window.location.href = '@Url.Action("Cardapio", "Home")';
    }

    // Inicializa o pre√ßo base quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
        const precoTexto = document.getElementById("produto-preco").innerText.replace("Pre√ßo: R$ ", "").replace(",", ".");
        precoBaseOriginal = parseFloat(precoTexto) || 0;
        
        // Se estiver editando, carrega os dados do item existente
        @if (ViewBag.Editando == true)
        {
            <text>
            carregarDadosEdicao();
            </text>
        }
    });
    
    function carregarDadosEdicao() {
        const itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
        const produtoId = @ViewBag.ProdutoId;
        
        // Encontra o item no carrinho
        const itemIndex = itens.findIndex(item => item.id === produtoId);
        if (itemIndex !== -1) {
            const item = itens[itemIndex];
            
            // Carrega as quantidades dos ingredientes
            // Itera sobre as propriedades do objeto 'ingredientes' para obter nome e quantidade
            Object.entries(item.ingredientes || {}).forEach(([nomeIngredienteItem, qtdItem]) => {
                const spans = document.querySelectorAll('.quantidade');
                spans.forEach(span => {
                    const ingredienteItemDiv = span.closest('.ingrediente-item');
                    if (ingredienteItemDiv) {
                        const nomeSpan = ingredienteItemDiv.querySelector('.ingrediente-nome');
                        // Verifica se o nome do ingrediente no HTML (removendo pre√ßo) corresponde ao nome do item no carrinho
                        const nomeHtmlLimpo = nomeSpan.textContent.split('(')[0].trim();
                        if (nomeHtmlLimpo === nomeIngredienteItem) {
                            span.innerText = qtdItem;
                        }
                    }
                });
            });
            
            // Atualiza o pre√ßo
            atualizarPrecoTempoReal();
        }
    }
</script>

<script>
    function alterarQtd(valor) {
        const input = document.getElementById("quantidade-lanche");
        let novaQtd = parseInt(input.value) + valor;
        if (novaQtd >= 1) input.value = novaQtd;
    }

    function alterarIngrediente(id, valor) {
        const span = document.getElementById(`quantidade-${id}`);
        let qtd = parseInt(span.innerText) + valor;
        if (qtd < 0) qtd = 0; // Garante que a quantidade n√£o seja negativa
        span.innerText = qtd;
        atualizarPrecoTempoReal();
    }

    function atualizarPrecoTempoReal() {
        let precoIngredientesExtras = 0.0;

        const precosIngredientes = {};
        const quantidadesPadrao = {};
        @if (ViewBag.Ingredientes != null)
        {
            foreach (var ingrediente in ViewBag.Ingredientes)
            {
                <text>precosIngredientes[@ingrediente.Id] = @(((double)ingrediente.Price).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture));</text>
                <text>quantidadesPadrao[@ingrediente.Id] = @ingrediente.Quantity;</text>
            }
        }

        document.querySelectorAll(".quantidade").forEach(span => {
            const idIngrediente = parseInt(span.id.replace("quantidade-", ""));
            const qtdAtual = parseInt(span.innerText) || 0;
            const qtdPadrao = quantidadesPadrao[idIngrediente] || 0;
            const qtdExtra = qtdAtual - qtdPadrao;
            
            if (qtdExtra > 0) {
                const precoIngrediente = parseFloat(precosIngredientes[idIngrediente]) || 0;
                precoIngredientesExtras += precoIngrediente * qtdExtra;
            }
        });

        const precoFinal = precoBaseOriginal + precoIngredientesExtras;
        
        const elementoPreco = document.getElementById("produto-preco");
        if (elementoPreco) {
            elementoPreco.textContent = `Pre√ßo: R$ ${precoFinal.toFixed(2).replace(".", ",")}`;
        }
    }

    function adicionarAoCarrinho() {
        const nome = document.getElementById("produto-nome").innerText.replace("Personalizar ", "").replace("Editar ", "");
        const editando = @(ViewBag.Editando == true ? "true" : "false");
        const produtoId = @ViewBag.ProdutoId;
        
        if (editando) {
            alert("Atualizando item no carrinho: " + nome);
        } else {
            alert("Adicionando ao carrinho: " + nome);
        }
        
        const quantidade = 1; // Quantidade de unidades do produto sendo adicionado/editado
        let precoBase = precoBaseOriginal;
        
        if (isNaN(precoBase) || precoBase <= 0) {
            alert("Erro: Pre√ßo base inv√°lido");
            return;
        }

        const ingredientes = {};
        const ingredientesExtras = {};
        let precoIngredientesExtras = 0.0;

        const precosIngredientes = {};
        const nomesIngredientes = {};
        const quantidadesPadrao = {};
        @if (ViewBag.Ingredientes != null)
        {
            foreach (var ingrediente in ViewBag.Ingredientes)
            {
                <text>precosIngredientes[@ingrediente.Id] = @(((double)ingrediente.Price).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture));</text>
                <text>nomesIngredientes[@ingrediente.Id] = "@ingrediente.Name";</text>
                <text>quantidadesPadrao[@ingrediente.Id] = @ingrediente.Quantity;</text>
            }
        }

        document.querySelectorAll(".quantidade").forEach(span => {
            const idIngrediente = parseInt(span.id.replace("quantidade-", ""));
            const qtdAtual = parseInt(span.innerText) || 0;
            const qtdPadrao = quantidadesPadrao[idIngrediente] || 0;
            const qtdExtra = qtdAtual - qtdPadrao;
            
            // Salva a quantidade total no objeto ingredientes
            ingredientes[nomesIngredientes[idIngrediente]] = qtdAtual;
            
            // Se h√° ingredientes extras, calcula o pre√ßo e salva
            if (qtdExtra > 0) {
                const precoIngrediente = parseFloat(precosIngredientes[idIngrediente]) || 0;
                precoIngredientesExtras += precoIngrediente * qtdExtra;
                ingredientesExtras[nomesIngredientes[idIngrediente]] = qtdExtra;
            }
        });

        const precoFinal = precoBase + precoIngredientesExtras;
        const imagem = document.getElementById("produto-imagem").getAttribute("src");

        console.log("URL da imagem capturada:", imagem);

        if (isNaN(precoFinal) || precoFinal <= 0) {
            alert("Erro: Pre√ßo final inv√°lido");
            return;
        }

        const item = {
            id: produtoId,
            nome: nome,
            quantidade: quantidade, // Esta √© a quantidade de *unidades do produto*
            precoUnitario: precoFinal, // Este √© o pre√ßo de 1 unidade do produto com suas personaliza√ß√µes
            total: quantidade * precoFinal, // Total do item no carrinho (quantidade do produto * precoUnitario)
            ingredientes: ingredientes, // Todas as quantidades de ingredientes (padr√£o + extras)
            ingredientesExtras: ingredientesExtras, // Apenas os ingredientes extras adicionados
            precoIngredientesExtras: precoIngredientesExtras,
            imagem: imagem
        };

        if (!item.nome || isNaN(item.total) || item.total <= 0) {
            alert("Erro: Dados do item inv√°lidos");
            console.error("Item inv√°lido:", item);
            return;
        }

        let itens = [];
        try {
            itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
            if (!Array.isArray(itens)) itens = [];
        } catch (e) {
            itens = [];
        }
        
        if (editando) {
            const itemIndex = itens.findIndex(i => i.id === produtoId);
            if (itemIndex !== -1) {
                itens[itemIndex] = item;
            } else {
                itens.push(item);
            }
        } else {
            itens.push(item);
        }
        
        sessionStorage.setItem("itensCarrinho", JSON.stringify(itens));

        recalcularTotalComCupom(); 

        // Debug dos totais (agora ser√£o os totais j√° com o cupom aplicado, se houver)
        console.log("Salvando totais - Total itens:", sessionStorage.getItem("totalItens"), "Total pedido:", sessionStorage.getItem("totalPedido"));
        console.log("SessionStorage ap√≥s salvar:", {
            totalItens: sessionStorage.getItem("totalItens"),
            totalPedido: sessionStorage.getItem("totalPedido")
        });

        console.log("Itens no carrinho ap√≥s " + (editando ? "atualizar" : "adicionar") + ":", itens);
        
        window.location.href = '@Url.Action("Cardapio", "Home")';
    }

    function recalcularTotalComCupom() {
        let itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
        let totalBruto = 0;

        // Calcula o total dos itens sem desconto
        itens.forEach(item => {
            totalBruto += (item.total || 0);
        });

        let totalFinal = totalBruto;
        const cupomAplicado = sessionStorage.getItem("cupomAplicado") === "true";
        const descontoCupom = parseFloat(sessionStorage.getItem("descontoCupom")) || 0;

        // Se houver um cupom aplicado, aplica o desconto
        if (cupomAplicado && descontoCupom > 0) {
            totalFinal = totalBruto * (1 - descontoCupom);
        }

        sessionStorage.setItem("totalPedido", totalFinal.toFixed(2));
        
        // Atualiza o total de itens
        let totalItens = 0;
        itens.forEach(i => {
            totalItens += (i.quantidade || 0);
        });
        sessionStorage.setItem("totalItens", totalItens);
    }
</script>