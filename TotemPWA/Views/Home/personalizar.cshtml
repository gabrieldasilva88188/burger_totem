@{
    Layout = "_WelcomeLayout";
    var cardapioUrl = Url.Action("Cardapio", "Home");
    var nome = ViewBag.Nome ?? "Lanche";
    var preco = ViewBag.Preco ?? "0,00";
    var imagem = ViewBag.Imagem ?? "~/img/default.png";
}

<link rel="stylesheet" href="@Url.Content("~/css/personalizar.css")">

<div class="modal-content">

<img id="produto-imagem" src="@Url.Content(imagem)" alt="@nome" />

    <h2 id="produto-nome">Personalizar @nome</h2>
    <p id="produto-preco">Preço: R$ @preco</p>

    <h4 id="adicionar-ingredientes">Escolha os Ingredientes</h4>

    <div id="ingredientes-container">
        @if (ViewBag.Ingredientes != null)
        {
            foreach (var ingrediente in ViewBag.Ingredientes)
            {
                string nomeIngrediente = ingrediente.Name;
                double precoIngrediente = (double)ingrediente.Price;
                int limite = ingrediente.Limit;
                int quantidade = ingrediente.Quantity;
                <div class="ingrediente-item">
                    <span class="ingrediente-nome">@nomeIngrediente (R$ @precoIngrediente.ToString("0.00"))</span>
                    <div class="ingrediente-controles">
                        <button class="diminuir" onclick="alterarIngrediente('@nomeIngrediente', -1)">-</button>
                        <span id="quantidade-@nomeIngrediente" class="quantidade">@quantidade</span>
                        <button class="aumentar" onclick="alterarIngrediente('@nomeIngrediente', 1)">+</button>
                    </div>
                    <img src="@Url.Content("~/img/ingredientes/" + @nomeIngrediente.ToLower() + ".png")" alt="@nomeIngrediente" class="ingrediente-img">
                </div>
            }
        }
    </div>

    <div class="botoes-personalizar">
        <button class="back-btn" onclick="redirecionarCardapio()">← Voltar</button>
        <button id="confirmar-personalizacao" onclick="adicionarAoCarrinho()">Adicionar ao Carrinho</button>
    
    </div>


</div>

<script>
    const cardapioUrl = '@cardapioUrl';

    function redirecionarCardapio() {
        window.location.href = cardapioUrl;
    }
</script>

<script>
    function alterarQtd(valor) {
        const input = document.getElementById("quantidade-lanche");
        let novaQtd = parseInt(input.value) + valor;
        if (novaQtd >= 1) input.value = novaQtd;
    }

    function alterarIngrediente(nome, valor) {
        const span = document.getElementById(`quantidade-${nome}`);
        let qtd = parseInt(span.innerText) + valor;
        if (qtd < 0) qtd = 0;
        span.innerText = qtd;
    }

function adicionarAoCarrinho() {
    const nome = document.getElementById("produto-nome").innerText.replace("Personalizar ", "");
    const quantidade = 1;
    const precoTexto = document.getElementById("produto-preco").innerText.replace("Preço: R$ ", "").replace(",", ".");
    let precoBase = parseFloat(precoTexto);

    const ingredientes = {};
    let precoIngredientes = 0.0;

    // Atualizar o dicionário de preços dos ingredientes dinamicamente
    const precosIngredientes = {};
    @if (ViewBag.Ingredientes != null)
    {
        foreach (var ingrediente in ViewBag.Ingredientes)
        {
            <text>precosIngredientes["@ingrediente.Name"] = @(((double)ingrediente.Price).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture));</text>
        }
    }

    document.querySelectorAll(".quantidade").forEach(span => {
        const ingrediente = span.id.replace("quantidade-", "");
        const qtd = parseInt(span.innerText);
        if (qtd > 0) {
            ingredientes[ingrediente] = qtd;
            precoIngredientes += precosIngredientes[ingrediente] * qtd;
        }
    });

    const precoFinal = precoBase + precoIngredientes;
    const imagem = document.getElementById("produto-imagem").getAttribute("src");

    const item = {
        nome: nome,
        quantidade: quantidade,
        precoUnitario: precoFinal,
        total: quantidade * precoFinal,
        ingredientes: ingredientes,
        imagem: imagem
    };

    let itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
    itens.push(item);
    sessionStorage.setItem("itensCarrinho", JSON.stringify(itens));

    let totalItens = parseInt(sessionStorage.getItem("totalItens")) || 0;
    let totalPedido = parseFloat(sessionStorage.getItem("totalPedido")) || 0.0;

    totalItens += quantidade;
    totalPedido += item.total;

    sessionStorage.setItem("totalItens", totalItens);
    sessionStorage.setItem("totalPedido", totalPedido.toFixed(2));

    window.location.href = "/Home/Cardapio";
}



</script>
