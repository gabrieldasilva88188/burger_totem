@{
    Layout = "_WelcomeLayout";
    var cardapioUrl = Url.Action("Cardapio", "Home");
    var nome = ViewBag.Nome ?? "Lanche";
    var preco = ViewBag.Preco ?? "0,00";
    var imagem = ViewBag.Imagem ?? "~/img/default.png";
}

<link rel="stylesheet" href="@Url.Content("~/css/personalizar.css")">

<div class="modal-content">

<img id="produto-imagem" src="@imagem" alt="@nome" />

    <h2 id="produto-nome">@(ViewBag.Editando == true ? "Editar " : "Personalizar ")@nome</h2>
    <p id="produto-preco">Pre√ßo: R$ @preco</p>

    <div class="info-ingredientes">
        <p><strong>üí° Dica:</strong> Os ingredientes j√° v√™m inclusos no lanche. Adicione mais se desejar!</p>
    </div>

    <h4 id="adicionar-ingredientes">Escolha os Ingredientes</h4>

    <div id="ingredientes-container">
        @if (ViewBag.Ingredientes != null)
        {
            foreach (var ingrediente in ViewBag.Ingredientes)
            {
                string nomeIngrediente = ingrediente.Name;
                int idIngrediente = ingrediente.Id;
                double precoIngrediente = (double)ingrediente.Price;
                int limite = ingrediente.Limit;
                int quantidade = ingrediente.Quantity;
                <div class="ingrediente-item">
                    <span class="ingrediente-nome">@nomeIngrediente (R$ @precoIngrediente.ToString("0.00"))</span>
                    <div class="ingrediente-controles">
                        <button class="diminuir" onclick="alterarIngrediente(@idIngrediente, -1)">-</button>
                        <span id="quantidade-@idIngrediente" class="quantidade">@quantidade</span>
                        <button class="aumentar" onclick="alterarIngrediente(@idIngrediente, 1)">+</button>
                    </div>
                    <img src="@Url.Content("~/img/ingredientes/" + @nomeIngrediente.ToLower() + ".png")" alt="@nomeIngrediente" class="ingrediente-img">
                </div>
            }
        }
    </div>

    <div class="botoes-personalizar">
        <button class="back-btn" onclick="redirecionarCardapio()">‚Üê Voltar</button>
        <button id="confirmar-personalizacao" onclick="adicionarAoCarrinho()">@(ViewBag.Editando == true ? "Atualizar Carrinho" : "Adicionar ao Carrinho")</button>
    
    </div>


</div>

<script>
    const cardapioUrl = '@cardapioUrl';
    let precoBaseOriginal = 0;

    function redirecionarCardapio() {
        window.location.href = '@Url.Action("Cardapio", "Home")';
    }

    // Inicializa o pre√ßo base quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
        const precoTexto = document.getElementById("produto-preco").innerText.replace("Pre√ßo: R$ ", "").replace(",", ".");
        precoBaseOriginal = parseFloat(precoTexto) || 0;
        
        // Se estiver editando, carrega os dados do item existente
        @if (ViewBag.Editando == true)
        {
            <text>
            carregarDadosEdicao();
            </text>
        }
    });
    
    function carregarDadosEdicao() {
        const itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
        const produtoId = @ViewBag.ProdutoId;
        
        // Encontra o item no carrinho
        const itemIndex = itens.findIndex(item => item.id === produtoId);
        if (itemIndex !== -1) {
            const item = itens[itemIndex];
            
            // Carrega as quantidades dos ingredientes
            Object.entries(item.ingredientes).forEach(([nome, qtd]) => {
                // Procura o span com a quantidade pelo nome do ingrediente
                const spans = document.querySelectorAll('.quantidade');
                spans.forEach(span => {
                    const spanId = span.id;
                    // Como estamos usando IDs num√©ricos, vamos tentar encontrar pelo nome
                    // Vamos verificar se o span est√° dentro de um item que cont√©m o nome do ingrediente
                    const ingredienteItem = span.closest('.ingrediente-item');
                    if (ingredienteItem) {
                        const nomeSpan = ingredienteItem.querySelector('.ingrediente-nome');
                        if (nomeSpan && nomeSpan.textContent.includes(nome)) {
                            span.innerText = qtd;
                        }
                    }
                });
            });
            
            // Atualiza o pre√ßo
            atualizarPrecoTempoReal();
        }
    }
</script>

<script>
    function alterarQtd(valor) {
        const input = document.getElementById("quantidade-lanche");
        let novaQtd = parseInt(input.value) + valor;
        if (novaQtd >= 1) input.value = novaQtd;
    }

    function alterarIngrediente(id, valor) {
        const span = document.getElementById(`quantidade-${id}`);
        let qtd = parseInt(span.innerText) + valor;
        if (qtd < 0) qtd = 0;
        span.innerText = qtd;
        atualizarPrecoTempoReal();
    }

    function atualizarPrecoTempoReal() {
        let precoIngredientesExtras = 0.0;

        // Atualizar o dicion√°rio de pre√ßos dos ingredientes dinamicamente
        const precosIngredientes = {};
        const quantidadesPadrao = {};
        @if (ViewBag.Ingredientes != null)
        {
            foreach (var ingrediente in ViewBag.Ingredientes)
            {
                <text>precosIngredientes[@ingrediente.Id] = @(((double)ingrediente.Price).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture));</text>
                <text>quantidadesPadrao[@ingrediente.Id] = @ingrediente.Quantity;</text>
            }
        }

        document.querySelectorAll(".quantidade").forEach(span => {
            const idIngrediente = parseInt(span.id.replace("quantidade-", ""));
            const qtdAtual = parseInt(span.innerText) || 0;
            const qtdPadrao = quantidadesPadrao[idIngrediente] || 0;
            const qtdExtra = qtdAtual - qtdPadrao;
            
            if (qtdExtra > 0) {
                const precoIngrediente = parseFloat(precosIngredientes[idIngrediente]) || 0;
                precoIngredientesExtras += precoIngrediente * qtdExtra;
            }
        });

        const precoFinal = precoBaseOriginal + precoIngredientesExtras;
        
        // Atualiza o pre√ßo na tela
        const elementoPreco = document.getElementById("produto-preco");
        if (elementoPreco) {
            elementoPreco.textContent = `Pre√ßo: R$ ${precoFinal.toFixed(2).replace(".", ",")}`;
        }
    }

function adicionarAoCarrinho() {
    const nome = document.getElementById("produto-nome").innerText.replace("Personalizar ", "").replace("Editar ", "");
    const editando = @(ViewBag.Editando == true ? "true" : "false");
    const produtoId = @ViewBag.ProdutoId;
    
    if (editando) {
        alert("Atualizando item no carrinho: " + nome);
    } else {
        alert("Adicionando ao carrinho: " + nome);
    }
    
    const quantidade = 1;
    let precoBase = precoBaseOriginal;
    
    // Valida√ß√£o do pre√ßo base
    if (isNaN(precoBase) || precoBase <= 0) {
        alert("Erro: Pre√ßo base inv√°lido");
        return;
    }

    const ingredientes = {};
    const ingredientesExtras = {};
    let precoIngredientesExtras = 0.0;

    // Atualizar o dicion√°rio de pre√ßos dos ingredientes dinamicamente
    const precosIngredientes = {};
    const nomesIngredientes = {};
    const quantidadesPadrao = {};
    @if (ViewBag.Ingredientes != null)
    {
        foreach (var ingrediente in ViewBag.Ingredientes)
        {
            <text>precosIngredientes[@ingrediente.Id] = @(((double)ingrediente.Price).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture));</text>
            <text>nomesIngredientes[@ingrediente.Id] = "@ingrediente.Name";</text>
            <text>quantidadesPadrao[@ingrediente.Id] = @ingrediente.Quantity;</text>
        }
    }

    document.querySelectorAll(".quantidade").forEach(span => {
        const idIngrediente = parseInt(span.id.replace("quantidade-", ""));
        const qtdAtual = parseInt(span.innerText) || 0;
        const qtdPadrao = quantidadesPadrao[idIngrediente] || 0;
        const qtdExtra = qtdAtual - qtdPadrao;
        
        // Salva a quantidade total no objeto ingredientes
        ingredientes[nomesIngredientes[idIngrediente]] = qtdAtual;
        
        // Se h√° ingredientes extras, calcula o pre√ßo e salva
        if (qtdExtra > 0) {
            const precoIngrediente = parseFloat(precosIngredientes[idIngrediente]) || 0;
            precoIngredientesExtras += precoIngrediente * qtdExtra;
            ingredientesExtras[nomesIngredientes[idIngrediente]] = qtdExtra;
        }
    });

    const precoFinal = precoBase + precoIngredientesExtras;
    const imagem = document.getElementById("produto-imagem").getAttribute("src");

    // Debug da imagem
    console.log("URL da imagem capturada:", imagem);

    // Valida√ß√£o final dos valores
    if (isNaN(precoFinal) || precoFinal <= 0) {
        alert("Erro: Pre√ßo final inv√°lido");
        return;
    }

    const item = {
        id: produtoId,
        nome: nome,
        quantidade: quantidade,
        precoUnitario: precoFinal,
        total: quantidade * precoFinal,
        ingredientes: ingredientes,
        ingredientesExtras: ingredientesExtras,
        precoIngredientesExtras: precoIngredientesExtras,
        imagem: imagem
    };

    // Valida√ß√£o do item antes de adicionar
    if (!item.nome || isNaN(item.total) || item.total <= 0) {
        alert("Erro: Dados do item inv√°lidos");
        console.error("Item inv√°lido:", item);
        return;
    }

    let itens = [];
    try {
        itens = JSON.parse(sessionStorage.getItem("itensCarrinho")) || [];
        if (!Array.isArray(itens)) itens = [];
    } catch (e) {
        itens = [];
    }
    
    if (editando) {
        // Se estiver editando, substitui o item existente
        const itemIndex = itens.findIndex(i => i.id === produtoId);
        if (itemIndex !== -1) {
            itens[itemIndex] = item;
        } else {
            itens.push(item); // Fallback: adiciona se n√£o encontrar
        }
    } else {
        // Se n√£o estiver editando, adiciona novo item
        itens.push(item);
    }
    
    sessionStorage.setItem("itensCarrinho", JSON.stringify(itens));

    // Atualiza totais
    let totalItens = 0, totalPedido = 0;
    itens.forEach(i => {
        totalItens += (i.quantidade || 0);
        totalPedido += (i.total || 0);
    });
    sessionStorage.setItem("totalItens", totalItens);
    sessionStorage.setItem("totalPedido", totalPedido.toFixed(2));

    // Debug dos totais
    console.log("Salvando totais - Total itens:", totalItens, "Total pedido:", totalPedido);
    console.log("SessionStorage ap√≥s salvar:", {
        totalItens: sessionStorage.getItem("totalItens"),
        totalPedido: sessionStorage.getItem("totalPedido")
    });

    // Debug
    console.log("Itens no carrinho ap√≥s " + (editando ? "atualizar" : "adicionar") + ":", itens);
    console.log("Total do pedido:", totalPedido);
    console.log("Ingredientes extras:", ingredientesExtras);
    
    window.location.href = '@Url.Action("Cardapio", "Home")';
}



</script>
